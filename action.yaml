name: 'Use Private Action'
description: 'Clones private action into a runner and triggers it'

inputs:
  uses:
    description: "owner/repository containing the action"
    required: true
  github_app_id:
    description: "GitHub App Id"
    required: true
  github_app_private_key:
    description: "GitHub App Private Key"
    required: true
  with:
    description: "List of key/value inputs"
    required: false

runs:
  
  using: "composite"
  
  steps:
    - name: Cleanup & get private action owner
      run: |
        # Cleanup existing actions in this directory
        rm -rf ./actions/private-action
      shell: bash
    
    - name: Parse inputs
      id: parse-inputs
      run: |
        # Parse repo / org and branch names
        echo "::set-output name=action_repo::$(echo ${{ inputs.uses }} | awk -F '@' '{print $1}')"
        echo "::set-output name=organization::$(echo ${{ inputs.uses }} | awk -F '/' '{print $1}')"
        echo "::set-output name=branch::$(echo ${{ inputs.uses }} | awk -F '/' '{print $2}' | awk -F '@' '{print $2}')"
      shell: bash

    - name: Parse additional parameters
      id: parse-additional-parameters
      run: |
        # Parse parameters passed in with
        echo 'HELLOO!!'
        read -d "" INPUT_VARIABLES <<EOF
            A=B
            C=D
        EOF
        if [ -z "$INPUT_VARIABLES" ]; then
            echo "No additional parameters to process"
            exit 0
        fi
        readarray -t INPUT_ARRAY <<<"${INPUT_VARIABLES}"
        for i in "${INPUT_ARRAY[@]}"; do
            IFS=":" read -ra KEY_VALUES <<< "${i// /}"
            echo "INPUT_${KEY_VALUES[0]^^}"="${KEY_VALUES[1]}"
            # export "INPUT_${KEY_VALUES[0]^^}"="${KEY_VALUES[1]}"
        done
      shell: bash

    - name: Get Token
      id: github-app
      uses: peter-murray/workflow-application-token-action@v1
      with:
        application_id: ${{ inputs.github_app_id }}
        application_private_key: ${{ inputs.github_app_private_key }}
        organization: ${{ steps.parse-inputs.outputs.organization }}

    - name: Check-out the simple private action
      uses: actions/checkout@v2
      with:
        repository: ${{ steps.parse-inputs.outputs.action_repo }}
        ref: ${{ steps.parse-inputs.outputs.branch }}
        path: actions/private-action
        token: ${{ steps.github-app.outputs.token }}
        persist-credentials: false

    - name: Run private action
      uses: ./actions/private-action
